const { checkHelloJADEDatabase, performManualSync } = require('./routes/monitoring');

async function testOptimizedMonitoring() {
    try {
        console.log('üß™ Test du monitoring optimis√©...');
        console.log('='.repeat(60));
        
        // Test 1: V√©rification du statut PostgreSQL
        console.log('\nüìä Test 1: V√©rification du statut PostgreSQL...');
        const statusResult = await checkHelloJADEDatabase();
        
        console.log('‚úÖ Statut PostgreSQL:');
        console.log(`   - Status: ${statusResult.status}`);
        console.log(`   - Version: ${statusResult.version}`);
        console.log(`   - Message: ${statusResult.message}`);
        
        if (statusResult.syncStatus) {
            console.log('\nüîÑ Statut de synchronisation:');
            console.log(`   - √Ä jour: ${statusResult.syncStatus.isUpToDate}`);
            console.log(`   - Derni√®re sync: ${statusResult.syncStatus.lastSyncTime}`);
            console.log(`   - √Çge: ${statusResult.syncStatus.syncAgeMinutes} minutes`);
            console.log(`   - Message: ${statusResult.syncStatus.message}`);
        }
        
        // Test 2: Synchronisation optimis√©e
        console.log('\nüîÑ Test 2: Synchronisation optimis√©e...');
        const syncResult = await performManualSync();
        
        console.log('‚úÖ R√©sultat synchronisation optimis√©e:');
        console.log(`   - Succ√®s: ${syncResult.success}`);
        console.log(`   - Timestamp: ${syncResult.timestamp}`);
        console.log(`   - Dur√©e totale: ${syncResult.totalDuration}ms`);
        console.log(`   - Message: ${syncResult.message}`);
        
        if (syncResult.results) {
            console.log('\nüìä D√©tails par table (avec m√©triques de performance):');
            Object.entries(syncResult.results).forEach(([table, result]) => {
                if (result.success) {
                    console.log(`   - ${table}: ‚úÖ ${result.message}`);
                    console.log(`     Dur√©e: ${result.duration}ms, D√©bit: ${result.throughput} rec/sec`);
                } else {
                    console.log(`   - ${table}: ‚ùå ${result.message}`);
                }
            });
        }
        
        // Test 3: V√©rification apr√®s synchronisation
        console.log('\nüìä Test 3: V√©rification apr√®s synchronisation...');
        const statusAfterSync = await checkHelloJADEDatabase();
        
        console.log('‚úÖ Statut apr√®s synchronisation:');
        console.log(`   - Status: ${statusAfterSync.status}`);
        console.log(`   - Message: ${statusAfterSync.message}`);
        
        if (statusAfterSync.syncStatus) {
            console.log(`   - √Ä jour: ${statusAfterSync.syncStatus.isUpToDate}`);
            console.log(`   - Derni√®re sync: ${statusAfterSync.syncStatus.lastSyncTime}`);
        }
        
        console.log('\nüéâ Tests du monitoring optimis√© termin√©s avec succ√®s !');
        
        // R√©sum√© des am√©liorations
        console.log('\nüìà Am√©liorations apport√©es:');
        console.log('   ‚úÖ Synchronisation par batch de 1000 enregistrements');
        console.log('   ‚úÖ Utilisation de COPY PostgreSQL pour insertion rapide');
        console.log('   ‚úÖ Pool de connexions optimis√© (20 connexions)');
        console.log('   ‚úÖ M√©triques de performance d√©taill√©es');
        console.log('   ‚úÖ Optimisation automatique des tables au d√©marrage');
        console.log('   ‚úÖ Index et statistiques optimis√©s');
        
    } catch (error) {
        console.error('‚ùå Erreur lors des tests:', error);
    }
}

// Ex√©cution des tests
testOptimizedMonitoring(); 